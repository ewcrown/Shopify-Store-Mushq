<script>
document.addEventListener("DOMContentLoaded", function () {
  let loadTimeout;
  let scrollTimeout;

  // ---------------------------
  // ðŸŽ¨ Load BaadMay Assets
  // ---------------------------
  function loadBaadmayAssets() {
    // Load CSS once
    if (!document.getElementById("baadmay-css")) {
      const css = document.createElement("link");
      css.id = "baadmay-css";
      css.rel = "stylesheet";
      css.href = "https://baadmay.com/assets/baadmay-styles.css";
      document.head.appendChild(css);
    }

    // Always reload BaadMay JS
    reloadBaadmayScript();
  }

  function reloadBaadmayScript() {
    const oldScript = document.getElementById("baadmay-js");
    if (oldScript) oldScript.remove();

    const script = document.createElement("script");
    script.id = "baadmay-js";
    script.src = "https://baadmay.com/assets/baadmay-scripts.js?reload=" + Date.now();
    
    // Inject the script into the body to load the BaadMay functionality
    document.body.appendChild(script);
    
    // IMPORTANT: Re-run VenoBox initialization after the BaadMay script loads,
    // as the script might be dynamically inserting the elements VenoBox targets.
    script.onload = function() {
      initializeVenoBoxAndPriceLogic();
    };
  }

  // ---------------------------
  // ðŸš€ Load Assets on Page Load
  // ---------------------------
  window.addEventListener("load", function () {
    loadBaadmayAssets();
  });

  // ---------------------------
  // ðŸ” Reload on Cart or Drawer Actions
  // ---------------------------
  const selectors = [
    ".product-form__submit", 
    ".header__icon", 
    ".btn-quantity", 
    ".halo-sidebar-close", 
    ".cart-remove",
    // Keep 'baadmay-popup-close' here to handle reloads even if it also closes the VenoBox
    ".baadmay-popup-close" 
  ];

  document.addEventListener("click", function (event) {
    const clickedEl = event.target.closest(selectors.join(","));
    if (clickedEl) {
      clearTimeout(loadTimeout);
      // Wait 2 seconds to ensure any backend/cart actions are complete
      loadTimeout = setTimeout(() => {
        loadBaadmayAssets();
      }, 2000);
    }
  });

  // ---------------------------
  // ðŸŒ€ Reload on Scroll (after 0.5s of no scroll)
  // ---------------------------
  window.addEventListener("scroll", function () {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      loadBaadmayAssets();
    }, 500); 
  });

  // =========================================================
  // ðŸ†• NEW FUNCTIONALITY: VenoBox & Price Logic
  // =========================================================
  function initializeVenoBoxAndPriceLogic() {
    // 1. Initialize VenoBox for the BaadMay modal
    var venobox = new VenoBox({
      selector: '.baadmay-modal',
      closeColor: '#000',
      closeBackground: 'transparent',
      overlayColor: 'rgba(0,0,0,.75)',
      overlayClose: false,
      customClass: 'baadmay-modal-container',
    });

    // 2. Handle closing the VenoBox modal when a close button is clicked
    document.addEventListener('click', function(event) {
      if (
        event.target.classList.contains('baadmay-popup-close') || 
        event.target.closest('.baadmay-popup-close')
      ) {
        // Use the VenoBox API to gracefully close the modal
        venobox.close(); 
        
        // The display logic is usually handled by VenoBox's close() method.
        // Explicitly hiding the overlay may not be necessary, but retained 
        // from your original code just in case, though it may be redundant.
        var modalContainer = document.querySelector('.vbox-overlay');
        if (modalContainer) {
          modalContainer.style.display = 'none';
        }
      }
    });

    // 3. Calculate and display the installment price (Price / 3)
    var baadmayElement = document.querySelector('baadmay');
    if (baadmayElement) {
      // Extract only digits from the text content of the <baadmay> element
      var baadmayPriceText = baadmayElement.textContent.replace(/[^0-9]/g, '');
      var originalPrice = parseInt(baadmayPriceText, 10);
      
      if (!isNaN(originalPrice) && originalPrice > 0) {
        // Calculate the installment amount
        var baadmayInstallment = Math.floor(originalPrice / 3); 

        // Update the content of the <baadmayprice> element
        var baadmayPriceElement = document.querySelector('baadmayprice');
        if (baadmayPriceElement) {
          baadmayPriceElement.textContent = baadmayInstallment;
        }
      }
    }
  }
  
  // NOTE: This logic is called automatically by reloadBaadmayScript on load,
  // which is better than calling it on DOMContentLoaded, because it ensures 
  // the logic is applied *after* the dynamically loaded baadmay-scripts.js runs.
});
</script>