{%- liquid 
    assign enable_border_top = block.settings.enable_border_top
    assign enable_border_bottom = block.settings.enable_border_bottom
    assign color_border = block.settings.color_border
    assign picker_type = block.settings.picker_type
-%}
<div class="productView-options{% if enable_border_top %} has-border-top{% endif %}{% if enable_border_bottom %} has-border-bottom{% endif %}" style="--color-border: {{ color_border }}" data-lang="{{ request.locale.iso_code | downcase }}" data-default-lang="{{ localization.country.iso_code | downcase }}">
    {%- if variantCount > 0  and product.has_only_default_variant != true -%}
        <div class="productView-variants halo-productOptions" id="product-option-{{ product.id }}"  data-type="{{ picker_type }}">
            {%- if picker_type == 'button' -%}
                {%- assign product_swatch_option = settings.swatch | downcase -%}
                <variant-radios class="no-js-hidden product-option has-default" data-product="{{ product.id }}" data-section="{{ section.id }}" data-url="{{ product.url }}">
                    {%- for option in product.options_with_values -%}
                        {%- liquid
                            assign is_swatch = false
                            assign option_name = option.name | downcase
                            if product_swatch_option contains option_name
                                assign is_swatch = true
                            endif
                            assign swatch_type = settings.swatch_type
                            assign option_index = forloop.index0
                            
                            comment
                                Load metaobjects color pattern once per option to avoid repeated lookups
                                Try different access methods for metaobject collections
                            endcomment
                            assign meta_color_codes = blank
                            if metaobjects['shopify--color-pattern'] != blank
                                assign meta_color_obj = metaobjects['shopify--color-pattern']
                                if meta_color_obj.values != blank
                                    assign meta_color_codes = meta_color_obj.values
                                elsif meta_color_obj.items != blank
                                    assign meta_color_codes = meta_color_obj.items
                                elsif meta_color_obj.records != blank
                                    assign meta_color_codes = meta_color_obj.records
                                endif
                            endif
                        -%}
                        <fieldset class="js product-form__input{% if is_swatch %} product-form__swatch{% endif %} clearfix" data-product-attribute="set-rectangle" data-option-index="{{ forloop.index0 }}">
                            <legend class="form__label">
                                {{ option.name | append: ':' }}
                                <span data-header-option>
                                    {{ option.selected_value }}
                                </span>
                            </legend>
                            {%- assign values = '' -%}
                            {%- liquid
                                assign variants_available_arr = product.variants | map: 'available'
                                assign variants_option1_arr = product.variants | map: 'option1'
                                assign variants_option2_arr = product.variants | map: 'option2'
                                assign variants_option3_arr = product.variants | map: 'option3'
                            -%}
                            {%- for variant in product.variants -%}
                                {%- assign value = variant.options[option_index] -%}
                                {%- unless values contains value -%}
                                    {%- liquid
                                        assign values = values | join: ';'
                                        assign values = values | append: ';' | append: value
                                        assign values = values | split: ';'
                                        assign option_stock = 'soldout'

                                        for option1_name in variants_option1_arr
                                            case option.position
                                                when 1
                                                    if variants_option1_arr[forloop.index0] == value and variants_available_arr[forloop.index0]
                                                        assign option_stock = 'available'
                                                    endif
                                                when 2
                                                    if option1_name == product.selected_or_first_available_variant.option1 and variants_option2_arr[forloop.index0] == value and variants_available_arr[forloop.index0]
                                                        assign option_stock = 'available'
                                                    endif
                                                when 3
                                                    if option1_name == product.selected_or_first_available_variant.option1 and variants_option2_arr[forloop.index0] == product.selected_or_first_available_variant.option2 and variants_option3_arr[forloop.index0] == value and variants_available_arr[forloop.index0]
                                                        assign option_stock = 'available'
                                                    endif
                                            endcase
                                        endfor
                                    -%}
                                    <input class="product-form__radio" type="radio" id="option-{{ product.id }}-{{ option.name }}-{{ forloop.index0 }}"
                                        name="{{ option.name }}"
                                        value="{{ value | escape }}"
                                        {% if option.selected_value == value %}checked{% endif %}
                                        {% if is_swatch and show_variant_image_group %}
                                            data-filter=".filter-{{ value | handle }}"
                                            data-metafields-vig="{{ variant.metafields.custom.variant_image_group }}"
                                        {% endif %}
                                        data-variant-id="{{ variant.id }}"
                                    >
                                    {%- if is_swatch -%}
                                        {%- liquid
                                            assign enable_variant_image = false
                                            case swatch_type
                                                when 'variant_image'
                                                    assign background_image = variant.image.src | product_img_url: '130x'
                                                    if variant.image
                                                        assign enable_variant_image = true
                                                    endif
                                                when 'color'
                                                    assign background_image = value | handle | append: '.png' | file_url
                                                    assign enable_variant_image = true
                                                when 'metafields'
                                                    assign variant_color = variant.metafields.custom.variant_color
                                                    assign color_codes = false
                    
                                                    if variant_color
                                                        assign enable_variant_image = true
                                                    
                                                        if variant_color contains '#' or variant_color contains 'rgb' or variant_color contains 'hsl'
                                                            assign color_codes = true
                                                            assign background_color = variant_color
                                                        else
                                                            assign background_image = variant_color | append: '.png' | file_url
                                                        endif
                                                    elsif variant.image
                                                        assign enable_variant_image = true
                                                        assign background_image = variant.image.src | product_img_url: '130x'
                                                    endif
                                                when 'metaobjects'
                                                    assign metaobject_color = value.swatch.color
                                                    assign metaobject_image = value.swatch.image
                                                    assign has_metaobject = false
                                                    assign has_image = false
                    
                                                    if metaobject_image != blank
                                                        assign background_image = metaobject_image | product_img_url: '120x'
                                                        assign enable_variant_image = true
                                                        assign has_metaobject = true
                                                        assign has_image = true
                                                    elsif metaobject_color != blank
                                                        assign background_color = metaobject_color
                                                        assign enable_variant_image = true
                                                        assign has_metaobject = true
                                                    elsif variant.image
                                                        assign background_image = variant.image.src | product_img_url: '120x'
                                                        assign enable_variant_image = true
                                                    endif
                                            endcase
                                        -%}
                                        {%- liquid
                                            comment
                                                Find matching color from metaobjects for this variant value
                                                First try direct access, then try collection matching
                                            endcomment
                                            assign found_hex = blank
                                            
                                            comment
                                                Try direct access to metaobject via value.swatch.color
                                                This is the most reliable method when metaobjects are linked to option values
                                                Handle both hex strings and RGB objects
                                            endcomment
                                            if value.swatch != blank and value.swatch.color != blank
                                                if value.swatch.color.rgb != blank
                                                    assign found_hex = 'rgb(' | append: value.swatch.color.rgb | append: ')'
                                                else
                                                    assign found_hex = value.swatch.color
                                                endif
                                            elsif meta_color_codes != blank and value != blank
                                                comment
                                                    Fallback: Try to match against metaobjects collection
                                                    Use multiple comparison methods for better matching
                                                endcomment
                                                assign compare_value_handle = value | strip | downcase | handle
                                                assign compare_value_direct = value | strip | downcase
                                                assign compare_value_no_spaces = value | strip | downcase | replace: ' ', ''
                                                assign compare_value_no_hyphens = value | strip | downcase | replace: '-', '' | replace: ' ', ''
                                                
                                                for color in meta_color_codes
                                                    comment
                                                        Try different label property names
                                                        Metaobjects might use label, display_name, name, or title
                                                    endcomment
                                                    assign meta_label = blank
                                                    if color.label != blank
                                                        assign meta_label = color.label
                                                    elsif color.display_name != blank
                                                        assign meta_label = color.display_name
                                                    elsif color.name != blank
                                                        assign meta_label = color.name
                                                    elsif color.title != blank
                                                        assign meta_label = color.title
                                                    endif
                                                    
                                                    if meta_label != blank
                                                        assign meta_label_handle = meta_label | strip | downcase | handle
                                                        assign meta_label_direct = meta_label | strip | downcase
                                                        assign meta_label_no_spaces = meta_label | strip | downcase | replace: ' ', ''
                                                        assign meta_label_no_hyphens = meta_label | strip | downcase | replace: '-', '' | replace: ' ', ''
                                                        
                                                        comment
                                                            Try multiple matching strategies for better color matching
                                                            Including handling for multi-word colors like "sea green"
                                                        endcomment
                                                        assign is_match = false
                                                        if compare_value_direct == meta_label_direct
                                                            assign is_match = true
                                                        elsif compare_value_handle == meta_label_handle
                                                            assign is_match = true
                                                        elsif compare_value_no_spaces == meta_label_no_spaces
                                                            assign is_match = true
                                                        elsif compare_value_no_hyphens == meta_label_no_hyphens
                                                            assign is_match = true
                                                        elsif compare_value_direct contains meta_label_direct or meta_label_direct contains compare_value_direct
                                                            assign is_match = true
                                                        elsif compare_value_handle contains meta_label_handle or meta_label_handle contains compare_value_handle
                                                            assign is_match = true
                                                        endif
                                                        
                                                        if is_match
                                                            comment
                                                                Try different property names for color value
                                                                Also check if the color has a swatch property
                                                                Handle RGB objects and convert to hex if needed
                                                            endcomment
                                                            if color.swatch != blank and color.swatch.color != blank
                                                                if color.swatch.color.rgb != blank
                                                                    assign found_hex = 'rgb(' | append: color.swatch.color.rgb | append: ')'
                                                                else
                                                                    assign found_hex = color.swatch.color
                                                                endif
                                                            elsif color.swatch != blank and color.swatch.hex != blank
                                                                assign found_hex = color.swatch.hex
                                                            elsif color.color != blank
                                                                if color.color.rgb != blank
                                                                    assign found_hex = 'rgb(' | append: color.color.rgb | append: ')'
                                                                else
                                                                    assign found_hex = color.color
                                                                endif
                                                            elsif color.hex != blank
                                                                assign found_hex = color.hex
                                                            elsif color.value != blank
                                                                assign found_hex = color.value
                                                            elsif color.code != blank
                                                                assign found_hex = color.code
                                                            elsif color.rgb != blank
                                                                assign found_hex = 'rgb(' | append: color.rgb | append: ')'
                                                            endif
                                                            if found_hex != blank
                                                                break
                                                            endif
                                                        endif
                                                    endif
                                                endfor
                                            endif
                                        -%}
                                        <label class="product-form__label {{ option_stock }}" name="{{ option.name }}" for="option-{{ product.id }}-{{ option.name }}-{{ forloop.index0 }}" data-variant-id="{{ variant.id }}">
                                            <span
                                                class="pattern"
                                                style="{% if found_hex != blank %}background-color: {{ found_hex | strip }};{% elsif enable_variant_image %}{% if swatch_type == 'metafields' %}{% if color_codes %} background: {{ background_color }};{% else %} background: url({{ background_image }}); background-size: cover;{% endif %}{% elsif has_metaobject and swatch_type == 'metaobjects' %}{% if has_image %}background: url({{ background_image }}); background-size: cover;{% else %}background: {{ background_color }};{% endif %}{% else %} background-image: url({{ background_image }});{% endif %}{% endif %}"
                                            ></span>
                                            {% if swatch_type == 'variant_image' and variant.image %}
                                                <span class="expand">
                                                    <img srcset="{{ variant.image.src | product_img_url: '75x'}}" src="{{ variant.image.src | product_img_url: '75x'}}" sizes="75px"{% if settings.enable_lazyload %} loading="lazy"{% endif %}>
                                                </span>
                                            {% endif %}
                                        </label>
                                    {%- else -%}   
                                        <label class="product-form__label {{ option_stock }}" for="option-{{ product.id }}-{{ option.name }}-{{ forloop.index0 }}" data-variant-id="{{ variant.id }}">
                                            <span class="text">{{ value }}</span>
                                        </label>
                                    {%- endif -%}
                                {%- endunless -%}
                            {%- endfor -%}
                        </fieldset>
                    {%- endfor -%}
                    <script type="application/json">
                        {{ product.variants | json }}
                    </script>
                </variant-radios>
            {%- else -%}
                <variant-selects class="no-js-hidden product-option has-default" data-product="{{ product.id }}" data-section="{{ section.id }}" data-url="{{ product.url }}">
                    {%- for option in product.options_with_values -%}
                        <div class="product-form__input product-form__input--dropdown" data-product-attribute="set-select" data-option-index="{{ forloop.index0 }}">
                            <label class="form__label" for="option-{{ forloop.index0 }}">
                                {{ option.name | append: ':' }}
                                <span data-header-option>
                                    {{ option.selected_value }}
                                </span>
                            </label>
                            <div class="form__select select">
                                <select id="option-{{ forloop.index0 }}"
                                    class="select__select"
                                    name="options[{{ option.name | escape }}]"
                                >
                                    {%- for value in option.values -%}
                                        <option value="{{ value | escape }}" {% if option.selected_value == value %}selected="selected"{% endif %}>
                                            {{ value }}
                                        </option>
                                    {%- endfor -%}
                                </select>
                            </div>
                        </div>
                    {%- endfor -%}
                    <script type="application/json">
                        {{ product.variants | json }}
                    </script>
                </variant-selects>
            {%- endif -%}
        </div>
        <noscript>
            <div class="product-form__input{% if product.has_only_default_variant %} hidden{% endif %}">
                <label class="form__label" for="Variants-{{ section.id }}">
                    {{ 'products.product.product_variants' | t }}
                </label>
                <div class="select">
                <select name="id" id="Variants-{{ section.id }}" class="select__select" form="product-form">
                    {%- for variant in product.variants -%}
                        <option
                            {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %}
                            {% if variant.available == false %}disabled{% endif %}
                            value="{{ variant.id }}"
                        >
                            {{ variant.title }}
                            {%- if variant.available == false %} - {{ 'products.product.sold_out' | t }}{% endif %}
                            - {{ variant.price | money | strip_html }}
                        </option>
                    {%- endfor -%}
              </select>
            </div>
          </div>
        </noscript>
    {%- endif -%}
</div>