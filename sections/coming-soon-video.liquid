{%- assign desktop_video = section.settings.desktop_video -%}
{%- assign desktop_video_url = section.settings.desktop_video_url -%}
{%- assign mobile_video = section.settings.mobile_video -%}
{%- assign mobile_video_url = section.settings.mobile_video_url -%}
{%- if desktop_video != blank or desktop_video_url != blank -%}
  {%- assign has_desktop = true -%}
{%- else -%}
  {%- assign has_desktop = false -%}
{%- endif -%}
{%- if mobile_video != blank or mobile_video_url != blank -%}
  {%- assign has_mobile = true -%}
{%- else -%}
  {%- assign has_mobile = false -%}
{%- endif -%}
{%- if has_desktop and has_mobile == false -%}
  {%- assign single_video = true -%}
{%- else -%}
  {%- assign single_video = false -%}
{%- endif -%}

<section class="video-responsive section-{{ section.id }}-padding">
  <div class="video-responsive__wrapper">
    {%- comment -%} Desktop video (or single video when no mobile set) {%- endcomment -%}
    {%- if has_desktop -%}
      <div class="video-responsive__item video-responsive__desktop{% if single_video %} video-responsive__single{% endif %}" aria-hidden="true">
        {%- if desktop_video != blank -%}
          {{
            desktop_video
            | video_tag:
              image_size: '1400x',
              autoplay: section.settings.autoplay,
              loop: section.settings.loop,
              muted: section.settings.muted,
              controls: section.settings.controls,
              playsinline: true
          }}
        {%- elsif desktop_video_url != blank -%}
          {%- if desktop_video_url.type == 'youtube' -%}
            <iframe
              src="https://www.youtube.com/embed/{{ desktop_video_url.id }}?autoplay={{ section.settings.autoplay | default: 0 }}&mute={{ section.settings.muted | default: 1 }}&loop={{ section.settings.loop | default: 1 }}&playlist={{ desktop_video_url.id }}&playsinline=1"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              loading="lazy"
            ></iframe>
          {%- elsif desktop_video_url.type == 'vimeo' -%}
            <iframe
              src="https://player.vimeo.com/video/{{ desktop_video_url.id }}?autoplay={{ section.settings.autoplay | default: 0 }}&loop={{ section.settings.loop | default: 1 }}&muted={{ section.settings.muted | default: 1 }}"
              frameborder="0"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              loading="lazy"
            ></iframe>
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- comment -%} Mobile video (only when different from desktop) {%- endcomment -%}
    {%- if has_mobile -%}
      <div class="video-responsive__item video-responsive__mobile" aria-hidden="true">
        {%- if mobile_video != blank -%}
            {{
              mobile_video
              | video_tag:
                image_size: '800x',
                autoplay: section.settings.autoplay,
                loop: section.settings.loop,
                muted: section.settings.muted,
                controls: section.settings.controls,
                playsinline: true
            }}
          {%- elsif mobile_video_url != blank -%}
            {%- if mobile_video_url.type == 'youtube' -%}
              <iframe
                src="https://www.youtube.com/embed/{{ mobile_video_url.id }}?autoplay={{ section.settings.autoplay | default: 0 }}&mute={{ section.settings.muted | default: 1 }}&loop={{ section.settings.loop | default: 1 }}&playlist={{ mobile_video_url.id }}&playsinline=1"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                loading="lazy"
              ></iframe>
            {%- elsif mobile_video_url.type == 'vimeo' -%}
              <iframe
                src="https://player.vimeo.com/video/{{ mobile_video_url.id }}?autoplay={{ section.settings.autoplay | default: 0 }}&loop={{ section.settings.loop | default: 1 }}&muted={{ section.settings.muted | default: 1 }}"
                frameborder="0"
                allow="autoplay; fullscreen; picture-in-picture"
                allowfullscreen
                loading="lazy"
              ></iframe>
            {%- endif -%}
          {%- endif -%}
      </div>
    {%- endif -%}

    {%- if has_desktop == false and has_mobile == false -%}
      <div class="video-responsive__placeholder">
        {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
        <p class="video-responsive__placeholder-text">Add a video in the theme settings</p>
      </div>
    {%- endif -%}
  </div>

  {%- if section.settings.show_notify_button -%}
    <div class="video-responsive__notify">
      <button type="button" class="video-responsive__notify-trigger" aria-expanded="false" aria-controls="NotifyForm-{{ section.id }}" data-notify-trigger>
        {{ section.settings.notify_button_label }}
      </button>
      <div id="NotifyForm-{{ section.id }}" class="video-responsive__notify-form" hidden data-notify-form>
        {%- form 'customer', class: 'video-responsive__newsletter-form' -%}
          <input type="hidden" name="contact[tags]" value="newsletter">
          {%- if form.posted_successfully? -%}
            <p class="video-responsive__notify-message video-responsive__notify-message--success" tabindex="-1" autofocus>
              {{ section.settings.notify_success_message }}
            </p>
          {%- else -%}
            {%- if form.errors -%}
              <p class="video-responsive__notify-message video-responsive__notify-message--error">
                {{ form.errors.translated_fields.email | capitalize }} {{ form.errors.messages.email }}
              </p>
            {%- endif -%}
            <div class="video-responsive__notify-field">
              <label for="NotifyEmail-{{ section.id }}" class="visually-hidden">{{ section.settings.notify_email_placeholder }}</label>
              <input
                type="email"
                id="NotifyEmail-{{ section.id }}"
                name="contact[email]"
                class="video-responsive__notify-input"
                value="{{ form.email }}"
                placeholder="{{ section.settings.notify_email_placeholder }}"
                required
                autocorrect="off"
                autocapitalize="off"
                autocomplete="email"
              >
              <button type="submit" class="video-responsive__notify-submit">
                {{ section.settings.notify_submit_label }}
              </button>
            </div>
          {%- endif -%}
        {%- endform -%}
      </div>
    </div>
  {%- endif -%}
</section>

<script>
  document.querySelectorAll('.video-responsive [data-notify-trigger]').forEach(function(trigger) {
    var formWrapper = trigger.closest('.video-responsive').querySelector('[data-notify-form]');
    if (!formWrapper) return;
    trigger.addEventListener('click', function() {
      var isOpen = !formWrapper.hidden;
      formWrapper.hidden = isOpen;
      trigger.setAttribute('aria-expanded', !isOpen);
      if (!isOpen) {
        var input = formWrapper.querySelector('input[type="email"]');
        if (input) setTimeout(function() { input.focus(); }, 100);
      }
    });
  });
</script>

{% schema %}
{
  "name": "Coming soon video",
  "tag": "section",
  "class": "video-responsive-section",
  "settings": [
    {
      "type": "header",
      "content": "Desktop video"
    },
    {
      "type": "video",
      "id": "desktop_video",
      "label": "Desktop video (upload)",
      "info": "Upload a video file. Ignored if YouTube/Vimeo URL is set."
    },
    {
      "type": "video_url",
      "id": "desktop_video_url",
      "accept": ["youtube", "vimeo"],
      "label": "Desktop video (YouTube or Vimeo)",
      "info": "Use this or upload a video above."
    },
    {
      "type": "header",
      "content": "Mobile video"
    },
    {
      "type": "video",
      "id": "mobile_video",
      "label": "Mobile video (upload)",
      "info": "Different video for mobile. Leave blank to use desktop video on all devices."
    },
    {
      "type": "video_url",
      "id": "mobile_video_url",
      "accept": ["youtube", "vimeo"],
      "label": "Mobile video (YouTube or Vimeo)",
      "info": "Use this or upload a video above. Leave both blank to use desktop video."
    },
    {
      "type": "header",
      "content": "Playback"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay",
      "default": true,
      "info": "Videos must be muted for autoplay in most browsers."
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "Loop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "muted",
      "label": "Muted",
      "default": true,
      "info": "Required for autoplay on mobile."
    },
    {
      "type": "checkbox",
      "id": "controls",
      "label": "Show controls",
      "default": false
    },
    {
      "type": "header",
      "content": "Notify / Newsletter"
    },
    {
      "type": "checkbox",
      "id": "show_notify_button",
      "label": "Show notify button",
      "default": true
    },
    {
      "type": "text",
      "id": "notify_button_label",
      "label": "Notify button label",
      "default": "Notify Me"
    },
    {
      "type": "text",
      "id": "notify_email_placeholder",
      "label": "Email placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "notify_submit_label",
      "label": "Submit button label",
      "default": "Subscribe"
    },
    {
      "type": "text",
      "id": "notify_success_message",
      "label": "Success message",
      "default": "Thanks for subscribing!"
    },
    {
      "type": "color",
      "id": "notify_button_bg",
      "label": "Notify button background",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "notify_button_text",
      "label": "Notify button text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Coming soon video"
    }
  ]
}
{% endschema %}

<style>
  .video-responsive-section.section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media screen and (min-width: 750px) {
    .video-responsive-section.section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .video-responsive {
    width: 100%;
    overflow: hidden;
  }

  .video-responsive__wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
  }

  .video-responsive__item {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .video-responsive__desktop {
    display: none;
  }

  .video-responsive__desktop.video-responsive__single {
    display: flex;
  }

  .video-responsive__mobile {
    display: flex;
  }

  @media screen and (min-width: 769px) {
    .video-responsive__desktop {
      display: flex;
    }

    .video-responsive__desktop.video-responsive__single {
      display: flex;
    }

    .video-responsive__mobile {
      display: none;
    }
  }

  .video-responsive__item video,
  .video-responsive__item iframe {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .video-responsive__item iframe {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 100%;
    width: 56.25vh;
    min-width: 100%;
    height: 56.25vw;
    min-height: 100%;
  }

  .video-responsive__placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    color: #666;
  }

  .video-responsive__placeholder .placeholder-svg {
    width: 60%;
    max-width: 300px;
    opacity: 0.5;
  }

  .video-responsive__placeholder-text {
    margin-top: 1rem;
    font-size: 0.9rem;
  }

  /* Notify / Newsletter */
.video-responsive__notify {
    max-width: 400px;
    margin: 24px auto 0;
    text-align: center;
    position: absolute;
    bottom: 30px;
    right: 0;
    left: 0;
}

  .video-responsive__notify-trigger {
    display: inline-block;
    padding: 14px 24px;
    background: {{ section.settings.notify_button_bg }};
    color: {{ section.settings.notify_button_text }};
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .video-responsive__notify-trigger:hover {
    opacity: 0.9;
  }

  .video-responsive__notify-form {
    margin-top: 16px;
    padding: 20px;
    background: #f8f8f8;
    border-radius: 4px;
    text-align: left;
  }

  .video-responsive__notify-form[hidden] {
    display: none;
  }

  .video-responsive__notify-field {
    display: flex;
    gap: 8px;
  }

  .video-responsive__notify-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .video-responsive__notify-submit {
    padding: 12px 20px;
    background: {{ section.settings.notify_button_bg }};
    color: {{ section.settings.notify_button_text }};
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }
  .video-responsive__notify-submit:hover {
    opacity: 0.9;
  }

  .video-responsive__notify-message {
    margin: 0;
    font-size: 0.9rem;
  }
  .video-responsive__notify-message--success {
    color: #0a6;
  }
  .video-responsive__notify-message--error {
    color: #c00;
  }

  .video-responsive .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
